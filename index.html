<!DOCTYPE html>
<html lang="zh-CN">
<!-- 头部样式与原代码一致，省略重复部分 -->
<body>
    <!-- 页面结构与原代码一致，仅修改 <script> 部分 -->
    <script>
        // DOM元素、加载配置、拖放处理等原有函数不变，仅修改「上传逻辑」和「工作流触发」
        
        // 1. 上传按钮点击事件：批量上传所有文件，收集成功文件后单次触发工作流
        uploadBtn.addEventListener('click', async () => {
            saveSettings();
            const token = githubToken.value;
            const username = githubUsername.value;
            const repo = githubRepo.value;
            const branch = githubBranch.value;
            let path = filePath.value;
            
            // 配置验证（同原逻辑）
            if (!token || !username || !repo || files.length === 0) {
                showMessage('请完善GitHub配置并选择文件', 'error');
                return;
            }
            if (path && !path.endsWith('/')) path += '/'; // 确保路径以斜杠结尾
            
            uploadBtn.disabled = true;
            uploadBtn.innerHTML = '<i class="fa fa-spinner fa-spin mr-2"></i>上传中...';
            
            try {
                // 关键：收集所有成功上传的文件信息
                const successFiles = [];
                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    try {
                        // 仅上传文件，不单独触发工作流
                        await uploadFileToGitHub(file, token, username, repo, branch, path, i);
                        // 记录成功的文件（name + 完整路径）
                        successFiles.push({
                            name: file.name,
                            path: path + file.name // 仓库中的完整路径，如 "src/upload/assets/xxx.docx"
                        });
                    } catch (error) {
                        showMessage(`文件 "${file.name}" 上传失败: ${error.message}`, 'error');
                        console.error(`文件 "${file.name}" 上传失败:`, error);
                    }
                }
                
                // 2. 关键：所有文件上传完成后，只触发一次工作流（批量传递成功文件）
                if (successFiles.length > 0) {
                    await triggerBatchWorkflow(successFiles, token, username, repo);
                    showMessage(`成功上传 ${successFiles.length}/${files.length} 个文件，记录已批量更新`, 'success');
                }
                
                // 清空文件列表
                files = [];
                renderFileList();
            } catch (error) {
                console.error('整体上传流程出错:', error);
                showMessage(`上传流程失败: ${error.message}`, 'error');
            } finally {
                uploadBtn.disabled = false;
                uploadBtn.innerHTML = '<i class="fa fa-upload mr-2"></i>上传所有文件';
            }
        });

        /**
         * 新增：批量触发工作流（传递所有成功文件，仅触发一次）
         * @param {Array} successFiles - 成功上传的文件列表（含name和path）
         * @param {string} token - GitHub PAT
         * @param {string} username - GitHub用户名
         * @param {string} repo - 仓库名
         */
        async function triggerBatchWorkflow(successFiles, token, username, repo) {
            const batchTimestamp = new Date().toISOString(); // 批量操作的统一时间戳
            try {
                const response = await fetch(
                    `https://api.github.com/repos/${username}/${repo}/dispatches`,
                    {
                        method: 'POST',
                        headers: {
                            'Authorization': `token ${token}`,
                            'Accept': 'application/vnd.github.v3+json',
                            'Content-Type': 'application/json'
                        },
                        // 关键：传递文件数组，而非单个文件
                        body: JSON.stringify({
                            event_type: 'file_uploaded', // 保持原有事件类型，无需改工作流
                            client_payload: {
                                batch_files: successFiles, // 批量文件列表
                                batch_timestamp: batchTimestamp // 批量时间戳
                            }
                        })
                    }
                );
                
                if (!response.ok) {
                    const errorRes = await response.json();
                    throw new Error(`工作流触发失败: ${response.status} - ${errorRes.message}`);
                }
                console.log(`批量工作流触发成功，共处理 ${successFiles.length} 个文件`);
            } catch (error) {
                console.error('批量工作流触发出错:', error);
                showMessage(`文件上传成功，但批量更新记录失败: ${error.message}`, 'info');
                throw error; // 若需严格保证记录更新，可抛出错误中断流程
            }
        }

        /**
         * 修改：仅上传文件，移除单个文件触发工作流的逻辑
         */
        async function uploadFileToGitHub(file, token, username, repo, branch, path, fileIndex) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                const fullFilePath = path + file.name;
                
                reader.onload = async (event) => {
                    try {
                        updateProgress(fileIndex, 20); // 进度：读取完成
                        const base64Content = event.target.result.split(',')[1];
                        const sha = await getFileSha(token, username, repo, branch, path, file.name);
                        
                        updateProgress(fileIndex, 40); // 进度：准备上传
                        const payload = {
                            message: `Upload file: ${file.name}`,
                            content: base64Content,
                            branch: branch
                        };
                        if (sha) payload.sha = sha; // 若文件已存在，传SHA更新
                        
                        // 发送上传请求
                        const response = await fetch(
                            `https://api.github.com/repos/${username}/${repo}/contents/${fullFilePath}`,
                            {
                                method: 'PUT',
                                headers: {
                                    'Authorization': `token ${token}`,
                                    'Content-Type': 'application/json',
                                    'Accept': 'application/vnd.github.v3+json'
                                },
                                body: JSON.stringify(payload)
                            }
                        );
                        
                        updateProgress(fileIndex, 70); // 进度：上传中
                        if (!response.ok) {
                            const errorRes = await response.json();
                            throw new Error(`文件上传失败: ${response.status} - ${errorRes.message}`);
                        }
                        
                        updateProgress(fileIndex, 100); // 进度：上传完成
                        resolve(); // 仅返回成功，不触发工作流
                    } catch (error) {
                        reject(error);
                    }
                };
                
                reader.onerror = (error) => reject(new Error(`文件读取错误: ${error.message}`));
                reader.readAsDataURL(file);
            });
        }

        // 其他函数（getFileSha、updateProgress、formatFileSize等）保持不变
    </script>
</body>
</html>