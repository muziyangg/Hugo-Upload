name: Deploy to GitHub Pages

on:
  push:
    branches: [ main ]
    # 事件级过滤：严格拦截含"Upload file:"的提交
    if: "!contains(github.event.head_commit.message, 'Upload file:')"
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pages: write
      id-token: write
    steps:
      - name: 打印部署触发原因
        run: |
          echo "工作流因以下原因触发："
          echo "事件类型: ${{ github.event_name }}"
          echo "提交信息: ${{ github.event.head_commit.message || '无（手动触发）' }}"
          echo "事件级过滤结果: 已通过（仅当提交不含'Upload file:'或手动触发时执行）"
          
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Setup Pages
        uses: actions/configure-pages@v4
        
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: '.'
          
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

  # 仅当事件级过滤未生效时，此作业才会执行（用于报警）
  filter-conflict-alert:
    runs-on: ubuntu-latest
    # 触发条件：push事件且提交含"Upload file:"（理论上不应执行）
    if: "github.event_name == 'push' && contains(github.event.head_commit.message, 'Upload file:')"
    steps:
      - name: 警告：过滤逻辑冲突
        run: |
          echo "⚠️ 严重错误：事件级过滤失效！"
          echo "提交信息: ${{ github.event.head_commit.message }}"
          echo "此提交本应被拦截，但进入了工作流！"
          exit 1  # 强制标记为失败，便于察觉问题
