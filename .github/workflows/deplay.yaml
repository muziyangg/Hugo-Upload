name: Deploy to GitHub Pages

on:
  push:
    branches: [ main ]
    # 事件级过滤：不含"Upload file:"的提交才触发
    if: "!contains(github.event.head_commit.message, 'Upload file:')"
  workflow_dispatch:
  # 新增一个专门用于记录过滤结果的事件触发
  repository_dispatch:
    types: [log-filter-result]

jobs:
  # 核心部署作业（仅在事件级过滤通过后执行）
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pages: write
      id-token: write
    steps:
      - name: 打印部署触发原因
        run: |
          echo "工作流因以下原因触发："
          echo "事件类型: ${{ github.event_name }}"
          echo "提交信息: ${{ github.event.head_commit.message || '无（手动触发）' }}"
          echo "事件级过滤结果: 已通过（此作业执行即证明）"
          
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Setup Pages
        uses: actions/configure-pages@v4
        
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: '.'
          
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

  # 影子作业：专门记录被事件级过滤拦截的提交
  log-filtered-events:
    runs-on: ubuntu-latest
    # 仅当提交信息含"Upload file:"且是push事件时执行
    if: "github.event_name == 'push' && contains(github.event.head_commit.message, 'Upload file:')"
    steps:
      - name: 记录被过滤的事件
        run: |
          echo "检测到被事件级过滤拦截的提交："
          echo "提交信息: ${{ github.event.head_commit.message }}"
          echo "提交作者: ${{ github.event.head_commit.author.name }}"
          echo "提交时间: ${{ github.event.head_commit.timestamp }}"
          echo "事件级过滤结果: 已拦截（此作业执行即证明）"
